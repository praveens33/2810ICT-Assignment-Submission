<div class="container mt-4">
  <div class="dashboard-header">
      <h2>Admin Dashboard</h2>
      <button (click)="goBack()" class="btn btn-secondary">‚Üê Go Back to Chat</button>
  </div>
  <div *ngIf="authService.currentUser && authService.currentUser.roles.includes('Super Admin')" class="dashboard-card">
    
    <div class="card-header">Global User Management</div>
    <div class="card-body">
      <hr>
      <h5 class="mt-3">Create New User</h5>
      <form #createUserForm="ngForm" (ngSubmit)="superAdminCreateUser()" class="d-flex align-items-center">
        <input type="text" class="form-control" [(ngModel)]="newUsername" name="newUsername" placeholder="Enter username..." required>
        <input type="email" class="form-control ms-2" [(ngModel)]="newUserEmail" name="newUserEmail" placeholder="Enter email..." required>
        <button type="submit" class="btn btn-primary ms-2" [disabled]="!createUserForm.form.valid">Create</button>
      </form>
      <table class="table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Roles</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of allUsers">
            <td>{{ user.username }}</td>
            <td>{{ user.roles.join(', ') }}</td>
            <td>
              <button *ngIf="!user.roles.includes('Group Admin')" (click)="promoteToGroupAdmin(user.id)" class="btn btn-sm btn-success">Promote to Group Admin</button>
              <button *ngIf="!user.roles.includes('Super Admin')" (click)="promoteToSuperAdmin(user.id)" class="btn btn-sm btn-warning ms-2">Promote to Super Admin</button>

              <button *ngIf="user.roles.includes('Group Admin') && user.username !== 'super'" (click)="demoteFromGroupAdmin(user.id)" class="btn btn-sm btn-secondary ms-2">Demote from Group Admin</button>
              <button *ngIf="user.roles.includes('Super Admin') && user.username !== 'super'" (click)="demoteFromSuperAdmin(user.id)" class="btn btn-sm btn-dark ms-2">Demote from Super Admin</button>
              
              <button *ngIf="user.username !== 'super'" (click)="removeUser(user.id)" class="btn btn-sm btn-danger ms-2">Remove User</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

<div *ngIf="authService.currentUser && authService.currentUser.roles.includes('Super Admin')" class="dashboard-card">
  <div class="card-header">Super Admin: All Groups Management</div>
  <div class="card-body">
    
    <div *ngFor="let group of allSystemGroups; let i = index" [class.mt-3]="i > 0">
      
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>{{ group.name }}</strong> (ID: {{ group.id }})
          <button (click)="superAdminDeleteGroup(group.id)" class="btn btn-danger btn-sm">Delete This Group</button>
        </div>
        <div class="card-body">
          <h5 class="card-title">Members</h5>
          <ul class="list-group">
            <li *ngIf="getUsersInGroup(group.id).length === 0" class="list-group-item text-muted">
              This group has no members.
            </li>
            <li *ngFor="let member of getUsersInGroup(group.id)" class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ member.username }}</span>
              <button (click)="superAdminRemoveUserFromGroup(member.id, group.id)" class="btn btn-outline-danger btn-sm">Remove from Group</button>
            </li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

  <div *ngIf="authService.currentUser && (authService.currentUser.roles.includes('Super Admin') || authService.currentUser.roles.includes('Group Admin'))">
    
    <div class="dashboard-card">
      <div class="card-header">Create New Group</div>
      <div class="card-body">
        <form (ngSubmit)="onCreateGroup()" class="d-flex">
          <input type="text" class="form-control" [(ngModel)]="newGroupName" name="newGroupName" placeholder="Enter new group name...">
          <button type="submit" class="btn btn-success ms-2">Create</button>
        </form>
      </div>
    </div>

    <h3 class="mt-4">Manage Your Groups</h3>
    
    <div *ngFor="let group of myOwnedGroups" class="dashboard-card">
      <div style="background-color: #dde0e6; color: #ffffff; padding: 1rem; margin-bottom: 1rem; border-radius: 5px;">
      </div>
  <div class="card-header d-flex justify-content-between align-items-center">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>{{ group.name }}</strong>
        <button (click)="removeGroup(group.id)" class="btn btn-danger btn-sm">Delete This Group</button>
      </div>
      <div class="card-body">

        <h5>Channels</h5>
        <ul class="list-group mb-3">
          <li *ngFor="let channel of getChannelsForGroup(group.id)" class="list-group-item d-flex justify-content-between align-items-center">
            <span>#{{ channel.name }}</span>
            <button (click)="removeChannel(channel.id)" class="btn btn-outline-danger btn-sm">Remove</button>
          </li>
        </ul>
        <form (ngSubmit)="onCreateChannel(group.id)" class="d-flex mt-3">
          <input type="text" class="form-control" [(ngModel)]="newChannelName" name="newChannelName" placeholder="New channel name...">
          <button type="submit" class="btn btn-primary ms-2">Add Channel</button>
        </form>
        <hr>
        <h5 class="mt-3">Members</h5>
        <ul class="list-group">
          <li *ngFor="let user of getUsersInGroup(group.id)" class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ user.username }}</span>
            <button *ngIf="user.id !== group.createdBy" (click)="removeUserFromGroup(user.id, group.id)" class="btn btn-outline-danger btn-sm">Remove from Group</button>
          </li>
        </ul>
        <form #addToChannelForm="ngForm" 
              (ngSubmit)="addUserToChannel(addToChannelForm.value.selectedUser, addToChannelForm.value.selectedChannel)"
              class="d-flex mt-3 align-items-center">

            <label class="me-2">Add Member:</label>
            <select name="selectedUser" ngModel class="form-select form-select-sm" required>
                <option [ngValue]="null" disabled>Select user...</option>
                <option *ngFor="let user of getUsersInGroup(group.id)" [value]="user.id">
                    {{ user.username }}
                </option>
            </select>

            <label class="mx-2">to Channel:</label>
            <select name="selectedChannel" ngModel class="form-select form-select-sm" required>
                <option [ngValue]="null" disabled>Select channel...</option>
                <option *ngFor="let channel of getChannelsForGroup(group.id)" [value]="channel.id">
                    #{{ channel.name }}
                </option>
            </select>

            <button type="submit" class="btn btn-primary btn-sm ms-2" [disabled]="!addToChannelForm.form.valid">Add</button>
        </form>
        <hr>

        
        <h5 class="mt-3">Manage Admins</h5>
        <ul class="list-group mb-3">
          <li *ngFor="let adminId of group.admins" class="list-group-item">
            Admin: {{ getUserById(adminId)?.username }}
          </li>
        </ul>
  
      <form #adminForm="ngForm" (ngSubmit)="addAdmin(adminForm.value.selectedUser, group.id)" class="d-flex mt-3">
        <select name="selectedUser" ngModel class="form-control">
          <option *ngFor="let user of getNonAdminMembers(group.id)" [value]="user.id">
            {{ user.username }}
          </option>
        </select>
      <button type="submit" class="btn btn-info ms-2">Make Admin</button>
      </form>
      <h5 class="mt-3">Pending Join Requests</h5>
    <ul class="list-group">
        <li *ngIf="group.requests.length === 0" class="list-group-item text-muted">
          No pending requests.
        </li>
        <li *ngFor="let userId of group.requests" class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ getUserById(userId)?.username }} wants to join</span>
          <div>
            <button (click)="approveRequest(userId, group.id)" class="btn btn-sm btn-success">Approve</button>
            <button (click)="denyRequest(userId, group.id)" class="btn btn-sm btn-danger ms-2">Deny</button>
          </div>
     </li>
    </ul>
    
    <h5 class="mt-3">Add New Member</h5>
  <form #addMemberForm="ngForm" (ngSubmit)="addMember(addMemberForm.value.selectedUser, group.id)" class="d-flex mt-3">
    <select name="selectedUser" ngModel class="form-control">
      <option [value]="null" disabled>Select a user to add...</option>
      <option *ngFor="let user of getNonMembers(group.id)" [value]="user.id">
        {{ user.username }}
      </option>
    </select>
    <button type="submit" class="btn btn-secondary ms-2">Add Member</button>
  </form>
      </div>
    </div>
  </div>
</div>